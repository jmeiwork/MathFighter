<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href='http://fonts.googleapis.com/css?family=Cagliostro' rel='stylesheet' type='text/css'>
    <style>
        

        body, button, input {
            font-family: 'Cagliostro', sans-serif;
        }

        #txtAnswer {
            width: 150px;
        }

        #matchAreaContainer{
            padding: 5px;
            margin-top: 20px;
            /*border: dashed 1px #bbbbbb;*/
        }

        #matchAreaContainer table.currentPlayer{
            border: double 2px #990000;
            color: #000000;
        }

        .history{
            width: 200px;
            float: left;
            border: dashed 1px #aaaaaa;
            padding: 3px;
            margin-right: 10px;
            color: #bbb;
        }

        #opponentsContainer, #myAnswersContainer table {
            float: left;
            
        }

        #btnReady{
            margin: 5px;
        }

        #announcements{
            clear: both;
        }

        #overlay{
            position: absolute;
            width: 500px;
            height: 300px;
            background-color: rgba(200,200,200,0.5);
            top: 150px;
            z-index: 9999;
        }

    </style>
</head>
<body>
    <!--
    <div><span>type your message:</span><span><input type="text" id="txtMessage" /></span></div>
    <div><button id="btnSend">Send</button></div>

    -->

    <h1>100</h1>

    <div><span>type the group you want to join:</span><span><input type="text" id="txtGroup" /></span><button id="btnJoin">Join</button></div>

    <button id="btnReady">Ready</button>
    <div><input type="text" id="txtAnswer" placeholder="Type your answer here" /><button id="btnNextEquation">Next Question</button></div>

    <div id="matchAreaContainer">
        <div id="myAnswersContainer">
            <table id="myConnectionId" class="history currentPlayer"></table>
        </div>
        <div id="opponentsContainer">Your Opponents:<br /></div>
    </div>

    <input type="hidden" id="hidQuestionCode" />
    <input type="hidden" id="hidQuestionId" />

    <div id="announcements"></div>
    <div id="messages"></div>
    <div id="overlay"></div>
    
    <script src="Scripts/jquery-1.6.4.js"></script>
    <script src="Scripts/jquery.signalR-2.0.3.js"></script>
    <script src="/signalr/hubs"></script>
    <script>
        $(function () {
            var playHub = $.connection.playHub;
            var questionBeingAnswered = "";
            $("#txtAnswer").hide();
            $("#btnNextEquation").hide();
            $("#matchAreaContainer table.currentPlayer").hide();
            $("#opponentsContainer").hide();
            $("#btnReady").hide();

            //=====================================  Callbacks  =============================================

            playHub.client.newJoinAnnouncement = function (message) {
                $("#announcements").append("<div>" + message + "</div>");
            }

            playHub.client.newMessage = function (data) {
                $("#messages").append("<div>" + data + "</div>");
            }

            playHub.client.setResult = function (connectionId, questionId, isCorrect) {
                if (isCorrect) {
                    $("#" + questionId + " .result").append("Correct!");
                }
                else {
                    $("#" + questionId + " .result").append("WRONG!!");
                }
            }

            playHub.client.setAnswer = function (connectionId, questionId, answer) {
                $("#" + questionId + " .answer").append(answer);
            }

            playHub.client.joinedGroup = function (joinSuccessful) {
                if (joinSuccessful) {
                    $("#btnReady").show();
                }
            }

            playHub.client.newQuestion = function (connectionId, data) {

                if (connectionId == playHub.connection.id) {
                    $("#hidQuestionCode").val(data.QuestionCode);
                    $("#hidQuestionId").val(data.QuestionId);
                }
                else {
                    if ($("#" + connectionId + ".history").length == 0) {
                        setupOpponent(connectionId);
                    }
                }
                $("#" + connectionId + ".history").prepend("<tr id='" + data.QuestionId + "'><td class='equation'>" + data.EquationString + "=</td><td class='answer'></td><td class='result'></td></tr>");

            }

            var setupOpponent = function (connectionId) {
                if (connectionId != playHub.connection.id) {
                    $("#matchAreaContainer").append("<table id='" + connectionId + "' class='history'></table>");
                }
            };

            playHub.client.setupOpponent = setupOpponent;

            //=======================================  Events Handlers  =========================================================

            $.connection.hub.start().done(function () {
                $("#myConnectionId").attr("id", playHub.connection.id);

                $("#btnSend").click(function () {
                    var data = $("#txtMessage").val();
                    playHub.server.sendMessageForRoom(
                        $("#txtGroup").val(), data
                    );
                });

                $("#btnJoin").click(function () {
                    var group = $("#txtGroup").val();
                    playHub.server.joinRoom(group);
                });

                //---------------
                $("#btnNextEquation").click(function () {
                    var answer = $("#txtAnswer").val();
                    var questionCode = $("#hidQuestionCode").val();
                    var questionId = $("#hidQuestionId").val();
                    playHub.server.submitAnswer($("#txtGroup").val(), questionCode, questionId, answer);
                })

                $("#txtAnswer").keyup(function (e) {
                    var code = e.which;
                    if (code == 13) //enter key
                    {
                        $("#btnNextEquation").click();
                        $("#txtAnswer").val("");
                    }
                });

                $("#btnReady").click(function () {
                    $("#overlay").show();
                    $("#btnReady").hide();
                    $("#txtAnswer").show();
                    $("#txtAnswer").focus();
                    $("#btnNextEquation").show();
                    $("#matchAreaContainer table.currentPlayer").show();
                    $("#opponentsContainer").show();


                    playHub.server.ready($("#txtGroup").val());
                });
            });
        });

    </script>
</body>











</html>
